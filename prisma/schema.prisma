// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rol {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique
  usuarios  Usuario[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Usuario {
  id         Int      @id @default(autoincrement())
  nombre     String
  email      String   @unique
  password   String
  rolId      Int
  rol        Rol      @relation(fields: [rolId], references: [id])
  sucursalId Int?
  sucursal   Sucursal? @relation(fields: [sucursalId], references: [id])
  movimientos Movimiento[] // Movimientos registrados por este usuario
  movimientosDiarios MovimientoDiario[] // Movimientos diarios registrados por este usuario
  movimientosDiariosHistorial MovimientoDiarioHistorial[] // Historial de cambios en movimientos diarios
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Sucursal {
  id                Int                @id @default(autoincrement())
  nombre            String             @unique
  direccion         String
  usuarios          Usuario[]
  movimientos       Movimiento[]
  movimientosDiarios MovimientoDiario[]
  fondoCajas        FondoCaja[]
  pedidosEspeciales PedidoEspecial[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model FormaDePago {
  id         Int         @id @default(autoincrement())
  nombre     String      @unique
  movimientos Movimiento[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model TipoGasto {
  id         Int         @id @default(autoincrement())
  nombre     String      @unique
  movimientos Movimiento[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

enum MovimientoTipo {
  VENTA
  GASTO
  FONDO_CAJA
}

model Movimiento {
  id            Int            @id @default(autoincrement())
  fecha         DateTime       @default(now())
  descripcion   String
  monto         Float
  tipo          MovimientoTipo
  imagen        String?        // URL o path de la imagen
  formaDePagoId Int?           // Solo para ventas
  formaDePago   FormaDePago?   @relation(fields: [formaDePagoId], references: [id])
  tipoGastoId   Int?           // Solo para gastos
  tipoGasto     TipoGasto?     @relation(fields: [tipoGastoId], references: [id])
  sucursalId    Int
  sucursal      Sucursal       @relation(fields: [sucursalId], references: [id])
  usuarioId     Int?           // Usuario que registró el movimiento
  usuario       Usuario?       @relation(fields: [usuarioId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model MovimientoDiario {
  id                Int      @id @default(autoincrement())
  fecha             DateTime @default(now())
  ventasBrutas      Float    @default(0)
  efectivo          Float    @default(0)
  credito           Float    @default(0)
  abonosCredito     Float    @default(0)
  recargas          Float    @default(0)
  pagoTarjeta       Float    @default(0)
  transferencias    Float    @default(0)
  gastos            Float    @default(0)
  saldoDia          Float    @default(0)
  observaciones     String?
  sucursalId        Int
  sucursal          Sucursal @relation(fields: [sucursalId], references: [id])
  usuarioId         Int?     // Usuario que registró el movimiento diario
  usuario           Usuario? @relation(fields: [usuarioId], references: [id])
  historial         MovimientoDiarioHistorial[] // Historial de cambios
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([fecha, sucursalId])
}

model MovimientoDiarioHistorial {
  id                    Int      @id @default(autoincrement())
  movimientoDiarioId    Int
  movimientoDiario      MovimientoDiario @relation(fields: [movimientoDiarioId], references: [id], onDelete: Cascade)
  usuarioId             Int
  usuario               Usuario @relation(fields: [usuarioId], references: [id])
  campoModificado       String   // "efectivo", "ventasBrutas", "observaciones", etc.
  valorAnterior         String   // Para mantener formato original
  valorNuevo            String
  fechaCambio           DateTime @default(now())
  observaciones         String?  // Comentario opcional del usuario
}

model FondoCaja {
  id         Int      @id @default(autoincrement())
  monto      Float
  fecha      DateTime @default(now())
  sucursalId Int
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model PedidoEspecial {
  id          Int      @id @default(autoincrement())
  descripcion String
  monto       Float
  fecha       DateTime @default(now())
  sucursalId  Int
  sucursal    Sucursal @relation(fields: [sucursalId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}